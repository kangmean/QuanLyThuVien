@model IEnumerable<Document>
@using QuanLyThuVien.Models

@{
    ViewData["Title"] = "Tài liệu đã upload";
    var hasDocuments = Model.Any();
    var totalCount = ViewBag.TotalCount ?? 0;
}

<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
            <li class="breadcrumb-item"><a asp-controller="Dashboard" asp-action="Index">Dashboard</a></li>
            <li class="breadcrumb-item active">📤 Upload của tôi</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-6 mb-2">
                        <i class="bi bi-cloud-upload text-primary"></i> Tài liệu đã upload
                    </h1>
                    <p class="text-muted mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        Quản lý tất cả tài liệu bạn đã đóng góp cho cộng đồng
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="stat-card bg-light p-3 rounded-3 d-inline-block">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-stack text-success fs-2 me-3"></i>
                            <div>
                                <div class="fs-4 fw-bold">@totalCount</div>
                                <div class="text-muted small">Tài liệu đã upload</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (!hasDocuments)
    {
        <!-- Empty State -->
        <div class="card shadow-sm border-0">
            <div class="card-body text-center py-5">
                <div class="empty-state-icon mb-4">
                    <i class="bi bi-cloud-upload display-1 text-muted"></i>
                </div>
                <h3 class="mb-3">Chưa upload tài liệu nào</h3>
                <p class="text-muted mb-4">
                    Chia sẻ tài liệu của bạn để giúp đỡ cộng đồng học tập!
                </p>
                <a asp-action="Create" class="btn btn-success btn-lg px-4">
                    <i class="bi bi-upload me-2"></i> Upload tài liệu đầu tiên
                </a>
            </div>
        </div>
    }
    else
    {
        <!-- Uploads Table -->
        <div class="card shadow-sm border-0">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>Danh sách tài liệu
                    <span class="float-end">
                        <a asp-action="Create" class="btn btn-sm btn-light">
                            <i class="bi bi-plus-circle me-1"></i>Thêm mới
                        </a>
                    </span>
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="5%">#</th>
                                <th width="40%">Tiêu đề</th>
                                <th width="15%">Thông tin</th>
                                <th width="15%">Thống kê</th>
                                <th width="10%">Trạng thái</th>
                                <th width="15%" class="text-end">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int counter = ((ViewBag.CurrentPage - 1) * 20) + 1;
                            }
                            @foreach (var document in Model)
                            {
                                <tr>
                                    <td>@(counter++)</td>
                                    <td>
                                        <h6 class="mb-1">
                                            <a asp-action="Details" asp-route-id="@document.Id" 
                                               class="text-decoration-none text-dark">
                                                @document.Title
                                            </a>
                                        </h6>
                                        <div class="small text-muted">
                                            <i class="bi bi-filetype-@(document.FileType.Replace(".", "")) me-1"></i>
                                            @document.FileType.ToUpper() • 
                                            @FormatFileSize(document.FileSize)
                                        </div>
                                    </td>
                                    <td>
                                        @if (document.University != null)
                                        {
                                            <div class="small">
                                                <i class="bi bi-building text-primary me-1"></i>
                                                @document.University.Name
                                            </div>
                                        }
                                        @if (document.Subject != null)
                                        {
                                            <div class="small">
                                                <i class="bi bi-book text-success me-1"></i>
                                                @document.Subject.Name
                                            </div>
                                        }
                                        <div class="small text-muted">
                                            <i class="bi bi-calendar me-1"></i>
                                            @document.UploadDate.ToString("dd/MM/yyyy")
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-3">
                                            <div class="text-center">
                                                <div class="fw-bold text-primary">@document.ViewCount</div>
                                                <small class="text-muted">👁️</small>
                                            </div>
                                            <div class="text-center">
                                                <div class="fw-bold text-success">@document.DownloadCount</div>
                                                <small class="text-muted">⬇️</small>
                                            </div>
                                            <div class="text-center">
                                                <div class="fw-bold text-warning">@document.AverageRating.ToString("0.0")</div>
                                                <small class="text-muted">⭐</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        @{
                                            var statusBadge = document.Status switch
                                            {
                                                DocumentStatus.Pending => "warning",
                                                DocumentStatus.Approved => "success",
                                                DocumentStatus.Rejected => "danger",
                                                DocumentStatus.Hidden => "secondary",
                                                _ => "secondary"
                                            };
                                            
                                            var statusText = document.Status switch
                                            {
                                                DocumentStatus.Pending => "Chờ duyệt",
                                                DocumentStatus.Approved => "Đã duyệt",
                                                DocumentStatus.Rejected => "Từ chối",
                                                DocumentStatus.Hidden => "Đã ẩn",
                                                _ => "Không xác định"
                                            };
                                        }
                                        <span class="badge bg-@statusBadge">@statusText</span>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group btn-group-sm">
                                            <a asp-action="Details" asp-route-id="@document.Id" 
                                               class="btn btn-outline-primary" title="Xem chi tiết">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            @if (document.Status == DocumentStatus.Pending || 
                                                 document.Status == DocumentStatus.Rejected ||
                                                 User.IsInRole("Admin"))
                                            {
                                                <a asp-action="Edit" asp-route-id="@document.Id" 
                                                   class="btn btn-outline-warning" title="Sửa">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                            }
                                            <a asp-action="Delete" asp-route-id="@document.Id" 
                                               class="btn btn-outline-danger" title="Xóa">
                                                <i class="bi bi-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pagination -->
            @if (ViewBag.TotalPages > 1)
            {
                <div class="card-footer">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center mb-0">
                            <!-- Previous -->
                            <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                                <a class="page-link" asp-action="MyUploads" asp-route-page="@(ViewBag.CurrentPage - 1)">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            
                            <!-- Page Numbers -->
                            @for (int i = 1; i <= ViewBag.TotalPages; i++)
                            {
                                <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                    <a class="page-link" asp-action="MyUploads" asp-route-page="@i">@i</a>
                                </li>
                            }
                            
                            <!-- Next -->
                            <li class="page-item @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "")">
                                <a class="page-link" asp-action="MyUploads" asp-route-page="@(ViewBag.CurrentPage + 1)">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                        <div class="text-center text-muted small mt-2">
                            Trang @ViewBag.CurrentPage/@ViewBag.TotalPages • 
                            Hiển thị @Model.Count()/@totalCount tài liệu
                        </div>
                    </nav>
                </div>
            }
        </div>
        
        <!-- Quick Stats -->
        <div class="row mt-4">
            <div class="col-md-3 col-6 mb-3">
                <div class="card bg-light border-0 text-center p-3">
                    <div class="text-primary fs-2">
                        <i class="bi bi-eye"></i>
                    </div>
                    <div class="fw-bold fs-4">@Model.Sum(d => d.ViewCount)</div>
                    <div class="text-muted small">Tổng lượt xem</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="card bg-light border-0 text-center p-3">
                    <div class="text-success fs-2">
                        <i class="bi bi-download"></i>
                    </div>
                    <div class="fw-bold fs-4">@Model.Sum(d => d.DownloadCount)</div>
                    <div class="text-muted small">Tổng lượt tải</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="card bg-light border-0 text-center p-3">
                    <div class="text-warning fs-2">
                        <i class="bi bi-star"></i>
                    </div>
                    <div class="fw-bold fs-4">@Model.Average(d => d.AverageRating).ToString("0.0")</div>
                    <div class="text-muted small">Điểm TB</div>
                </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
                <div class="card bg-light border-0 text-center p-3">
                    <div class="text-info fs-2">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <div class="fw-bold fs-4">@Model.Count(d => d.Status == DocumentStatus.Approved)</div>
                    <div class="text-muted small">Đã được duyệt</div>
                </div>
            </div>
        </div>
    }
</div>

@functions {
    // Hàm format file size
    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        int order = 0;
        double len = bytes;

        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }

        return $"{len:0.##} {sizes[order]}";
    }
}

@section Styles {
    <style>
        .table th {
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            color: #6c757d;
            border-bottom: 2px solid #dee2e6;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }
        
        .stat-card {
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: scale(1.05);
        }
        
        .btn-group .btn {
            border-radius: 4px !important;
            margin: 0 2px;
        }
        
        .empty-state-icon {
            opacity: 0.5;
        }
        
        .breadcrumb {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 12px 16px;
        }
        
        .card-header {
            border-radius: 8px 8px 0 0 !important;
        }
    </style>
}