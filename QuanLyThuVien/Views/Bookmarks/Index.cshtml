@model IEnumerable<Document>
@using QuanLyThuVien.Models

@{
    ViewData["Title"] = "Tài liệu đã bookmark";
    var hasBookmarks = Model.Any();
    var totalCount = ViewBag.TotalCount ?? 0;
}

<div class="container mt-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
            <li class="breadcrumb-item active">📌 Bookmarks</li>
        </ol>
    </nav>

    <!-- Header with Stats -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-6 mb-2">
                        <i class="bi bi-bookmark-star-fill text-primary"></i> Tài liệu đã bookmark
                    </h1>
                    <p class="text-muted mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        Lưu trữ tài liệu yêu thích của bạn để xem lại sau
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="stat-card bg-light p-3 rounded-3 d-inline-block">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-stack text-primary fs-2 me-3"></i>
                            <div>
                                <div class="fs-4 fw-bold">@totalCount</div>
                                <div class="text-muted small">Tài liệu đã lưu</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (!hasBookmarks)
    {
        <!-- Empty State -->
        <div class="card shadow-sm border-0">
            <div class="card-body text-center py-5">
                <div class="empty-state-icon mb-4">
                    <i class="bi bi-bookmark-x display-1 text-muted"></i>
                </div>
                <h3 class="mb-3">Chưa có tài liệu nào được bookmark</h3>
                <p class="text-muted mb-4">
                    Hãy tìm tài liệu bạn thích và nhấn nút <i class="bi bi-bookmark text-primary"></i> 
                    để lưu lại cho sau này!
                </p>
                <a asp-controller="Documents" asp-action="Index" class="btn btn-primary btn-lg px-4">
                    <i class="bi bi-search me-2"></i> Tìm tài liệu ngay
                </a>
            </div>
        </div>
    }
    else
    {
        <!-- Bookmarks Grid -->
        <div class="row">
            @foreach (var document in Model)
            {
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 shadow-sm border-0 hover-card">
                        <div class="card-body p-4">
                            <!-- Document Header -->
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary">
                                    @document.FileType.ToUpper()
                                </span>
                                <button class="btn btn-sm btn-outline-danger btn-remove-bookmark" 
                                        data-document-id="@document.Id" 
                                        title="Xóa khỏi bookmark">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            
                            <!-- Document Title -->
                            <h5 class="card-title mb-3">
                                <a asp-controller="Documents" asp-action="Details" asp-route-id="@document.Id" 
                                   class="text-decoration-none text-dark fw-bold">
                                    @document.Title
                                </a>
                            </h5>
                            
                            <!-- Document Description -->
                            @if (!string.IsNullOrEmpty(document.Description))
                            {
                                <p class="card-text text-muted small mb-4">
                                    @(document.Description.Length > 100 ? 
                                      document.Description.Substring(0, 100) + "..." : 
                                      document.Description)
                                </p>
                            }
                            
                            <!-- Document Metadata -->
                            <div class="document-meta mb-3">
                                @if (document.University != null)
                                {
                                    <div class="mb-1">
                                        <i class="bi bi-building text-primary me-1"></i>
                                        <small>@document.University.Name</small>
                                    </div>
                                }
                                @if (document.Subject != null)
                                {
                                    <div class="mb-1">
                                        <i class="bi bi-book text-success me-1"></i>
                                        <small>@document.Subject.Name</small>
                                    </div>
                                }
                                <div>
                                    <i class="bi bi-calendar text-muted me-1"></i>
                                    <small class="text-muted">@document.UploadDate.ToString("dd/MM/yyyy")</small>
                                </div>
                            </div>
                            
                            <!-- Document Stats -->
                            <div class="document-stats border-top pt-3">
                                <div class="d-flex justify-content-between">
                                    <div class="text-center">
                                        <div class="fw-bold text-primary">@document.ViewCount</div>
                                        <small class="text-muted">👁️ Lượt xem</small>
                                    </div>
                                    <div class="text-center">
                                        <div class="fw-bold text-success">@document.DownloadCount</div>
                                        <small class="text-muted">⬇️ Lượt tải</small>
                                    </div>
                                    <div class="text-center">
                                        <div class="fw-bold text-warning">@document.AverageRating.ToString("0.0")</div>
                                        <small class="text-muted">⭐ Đánh giá</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card Footer -->
                        <div class="card-footer bg-transparent border-top-0 pt-0">
                            <div class="d-flex justify-content-between">
                                <a asp-controller="Documents" asp-action="Details" asp-route-id="@document.Id" 
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye me-1"></i> Xem chi tiết
                                </a>
                                <a asp-controller="Documents" asp-action="Download" asp-route-id="@document.Id" 
                                   class="btn btn-sm btn-success">
                                    <i class="bi bi-download me-1"></i> Tải xuống
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        
        <!-- Pagination -->
        @if (ViewBag.TotalPages > 1)
        {
            <nav aria-label="Page navigation" class="mt-5">
                <ul class="pagination justify-content-center">
                    <!-- Previous Button -->
                    <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                        <a class="page-link" asp-action="Index" asp-route-page="@(ViewBag.CurrentPage - 1)">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    
                    <!-- Page Numbers -->
                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                    {
                        <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                            <a class="page-link" asp-action="Index" asp-route-page="@i">@i</a>
                        </li>
                    }
                    
                    <!-- Next Button -->
                    <li class="page-item @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "")">
                        <a class="page-link" asp-action="Index" asp-route-page="@(ViewBag.CurrentPage + 1)">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
                
                <!-- Page Info -->
                <div class="text-center text-muted small mt-2">
                    Trang @ViewBag.CurrentPage/@ViewBag.TotalPages • 
                    Hiển thị @Model.Count()/@totalCount tài liệu
                </div>
            </nav>
        }
    }
</div>

@section Styles {
    <style>
        /* Custom styles for Bookmarks page */
        .hover-card {
            transition: all 0.3s ease;
            border-radius: 12px;
        }
        
        .hover-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
        }
        
        .empty-state-icon {
            opacity: 0.5;
        }
        
        .stat-card {
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: scale(1.05);
        }
        
        .document-meta {
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .document-stats {
            font-size: 0.9rem;
        }
        
        .btn-remove-bookmark {
            transition: all 0.2s;
        }
        
        .btn-remove-bookmark:hover {
            background-color: #dc3545;
            color: white;
        }
        
        .card-footer {
            background: linear-gradient(to bottom, transparent, #f8f9fa 100%);
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function () {
            // Xử lý xóa bookmark với confirmation đẹp hơn
            $('.btn-remove-bookmark').click(function () {
                var documentId = $(this).data('document-id');
                var card = $(this).closest('.col-md-6');
                var documentTitle = card.find('.card-title').text().trim();
                
                // Sweet confirmation
                if (confirm(`Xóa "${documentTitle}" khỏi bookmark?`)) {
                    // Show loading state
                    $(this).html('<i class="bi bi-hourglass"></i>');
                    $(this).prop('disabled', true);
                    
                    $.post('/Bookmarks/Toggle', { documentId: documentId }, function (response) {
                        if (response.success) {
                            // Animate removal
                            card.animate({
                                opacity: 0,
                                marginLeft: '100px'
                            }, 300, function() {
                                $(this).remove();
                                
                                // Update count
                                var currentCount = parseInt($('.fs-4.fw-bold').text());
                                $('.fs-4.fw-bold').text(currentCount - 1);
                                
                                // Show toast
                                showToast('Đã xóa khỏi bookmark', 'success');
                                
                                // Check if empty
                                if ($('.col-md-6').length === 0) {
                                    setTimeout(function() {
                                        location.reload();
                                    }, 500);
                                }
                            });
                        } else {
                            showToast('Có lỗi: ' + response.message, 'error');
                            $(this).html('<i class="bi bi-trash"></i>');
                            $(this).prop('disabled', false);
                        }
                    }).fail(function() {
                        showToast('Có lỗi xảy ra', 'error');
                        $(this).html('<i class="bi bi-trash"></i>');
                        $(this).prop('disabled', false);
                    });
                }
            });
            
            // Toast function
            function showToast(message, type = 'info') {
                var icon = type === 'success' ? 'bi-check-circle' : 'bi-exclamation-circle';
                var bgColor = type === 'success' ? 'bg-success' : 'bg-danger';
                
                var toast = `
                    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
                        <div class="toast show" role="alert">
                            <div class="toast-header ${bgColor} text-white">
                                <i class="bi ${icon} me-2"></i>
                                <strong class="me-auto">Thông báo</strong>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                            </div>
                            <div class="toast-body">${message}</div>
                        </div>
                    </div>`;
                
                $('body').append(toast);
                
                // Auto remove after 3 seconds
                setTimeout(function() {
                    $('.toast').fadeOut(300, function() {
                        $(this).remove();
                    });
                }, 3000);
            }
            
            // Auto-dismiss toast on click
            $(document).on('click', '.toast .btn-close', function() {
                $(this).closest('.toast').remove();
            });
        });
    </script>
}